name: E2E Tests

on:
  pull_request:

jobs:
  e2e-docker:
    name: E2E (Docker/Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and run e2e tests in Docker
        run: make e2e

  e2e-native:
    name: E2E (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
          - os: macOS
            runner: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y sqlite3 jq

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install sqlite3 jq

      - name: Build release binary
        run: cargo build --release

      - name: Install binary
        run: |
          sudo cp target/release/jankenoboe /usr/local/bin/jankenoboe
          sudo chmod +x /usr/local/bin/jankenoboe

      - name: Initialize test database
        run: |
          mkdir -p /tmp/jankenoboe-e2e
          sqlite3 /tmp/jankenoboe-e2e/datasource.db < docs/init-db.sql

      - name: Run e2e tests
        env:
          JANKENOBOE_DB: /tmp/jankenoboe-e2e/datasource.db
          JANKENOBOE_INIT_SQL: ${{ github.workspace }}/docs/init-db.sql
          JANKENOBOE_BINARY_PATH: /usr/local/bin/jankenoboe
        run: |
          chmod +x e2e/run_tests.sh
          e2e/run_tests.sh

  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
          - os: macOS
            runner: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run unit and integration tests
        env:
          JANKENOBOE_DB: ":memory:"
        run: cargo test

      - name: Run clippy
        run: cargo clippy -- -D warnings